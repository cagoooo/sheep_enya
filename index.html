<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- 確保 RWD (響應式網頁設計) 正常運作 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>優化版 - 班級點數紀錄 (安全修正)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基礎樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        /* Toast 提示訊息的樣式 */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 100;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            opacity: 0;
            pointer-events: none; /* 讓 toast 不會擋住點擊 */
        }
        #toast.show {
            opacity: 1;
            bottom: 40px;
        }
        #toast.bg-red-500 { background-color: #ef4444; }
        #toast.bg-green-500 { background-color: #22c55e; }

        /* 確認對話框 (Modal) 的樣式 */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none; /* 預設隱藏 */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            z-index: 50;
            width: 90%;
            max-width: 400px;
            display: none; /* 預設隱藏 */
            opacity: 0;
            transition: opacity 0.3s ease, top 0.3s ease;
        }
        #modal-backdrop.show, #modal.show {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container max-w-5xl mx-auto p-4 md:p-8">

        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">班級點數紀錄</h1>

        <!-- 新增學生 -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <label for="newStudent" class="block text-sm font-medium text-gray-700 mb-2">新增學生</label>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="newStudent" placeholder="輸入學生姓名" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button onclick="addStudent()" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    新增
                </button>
            </div>
        </div>

        <!-- 學生操作 -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <label for="studentSelect" class="block text-sm font-medium text-gray-700 mb-2">選取學生 (進行加扣點)</label>
            <select id="studentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-6">
                <!-- 學生選項會由 JS 動態載入 -->
            </select>

            <h3 class="text-lg font-medium text-gray-800 mb-4">執行動作</h3>
            
            <!-- 操作按鈕群組 -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <!-- 加扣點 -->
                <button onclick="modifyPoint(1)" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md shadow-sm hover:bg-green-600">加點 (+1)</button>
                <button onclick="modifyPoint(-1)" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-sm hover:bg-red-600">扣點 (-1)</button>

                <!-- 警告 -->
                <button onclick="modifyWarning(1)" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-md shadow-sm hover:bg-yellow-600">新增警告</button>
                <button onclick="modifyWarning(-1)" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-sm hover:bg-gray-600">刪除警告</button>

                <!-- 兌換獎品 -->
                <button onclick="redeem('ice')" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-sm hover:bg-blue-600">兌換冰棒 (50點)</button>
                <button onclick="redeem('drink')" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md shadow-sm hover:bg-purple-600">兌換飲料 (150點)</button>
            </div>

            <!-- 請假 & 沒跑步 -->
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <select id="leaveType" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="病假">病假</option>
                    <option value="事假">事假</option>
                    <option value="公假">公假</option>
                    <option value="其他">其他</option>
                </select>
                <button onclick="addLeave()" class="w-full sm:w-auto px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-600">新增請假</button>
                <button onclick="missRunning()" class="w-full sm:w-auto px-4 py-2 bg-orange-500 text-white font-semibold rounded-md shadow-sm hover:bg-orange-600">沒跑步</button>
            </div>
        </div>

        <!-- 學生表格 -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-10">
            <div class="p-6 flex justify-between items-center flex-wrap gap-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-800">學生列表</h3>
                <!-- 批次刪除按鈕 -->
                <button id="batchDeleteBtn" onclick="confirmBatchDelete()" disabled class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-sm hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed transition-colors">
                    批次刪除
                </button>
            </div>
            
            <!-- RWD 表格：讓表格可以水平捲動 -->
            <div class="overflow-x-auto">
                <table class="w-full min-w-max">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <!-- 全選 Checkbox -->
                            <th class="px-4 py-3 text-center w-12">
                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">點數</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">警告</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">請假紀錄</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">沒跑步紀錄</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable" class="bg-white divide-y divide-gray-200">
                        <!-- 學生資料會由 JS 動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast (提示訊息) 元件 -->
    <div id="toast"></div>

    <!-- Modal (確認對話框) 元件 -->
    <div id="modal-backdrop"></div>
    <div id="modal">
        <h3 id="modal-title" class="text-lg font-semibold mb-4">確認操作</h3>
        <p id="modal-message" class="text-gray-700 mb-6">您確定要執行此操作嗎？</p>
        <div class="flex justify-end gap-3">
            <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300">取消</button>
            <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700">確認</button>
        </div>
    </div>


    <script>
        let students = [];
        let toastTimeout;
        let confirmCallback = null;

        // --- UI 相關函式 (Toast & Modal) ---

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = isError ? 'bg-red-500' : 'bg-green-500';
            toast.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showConfirm(message, callback, isDanger = false) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById('modal');
            const confirmBtn = document.getElementById('modal-confirm');
            
            document.getElementById('modal-message').textContent = message;
            
            // 根據危險程度改變確認按鈕顏色
            if (isDanger) {
                confirmBtn.className = "px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700";
            } else {
                confirmBtn.className = "px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700";
            }

            backdrop.classList.add('show');
            modal.classList.add('show');
            confirmCallback = callback;
        }

        document.getElementById('modal-confirm').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') confirmCallback();
            hideModal();
        });
        document.getElementById('modal-cancel').addEventListener('click', hideModal);
        document.getElementById('modal-backdrop').addEventListener('click', hideModal);

        function hideModal() {
            document.getElementById('modal-backdrop').classList.remove('show');
            document.getElementById('modal').classList.remove('show');
            confirmCallback = null;
        }

        // --- 資料儲存相關函式 ---
        function loadStudents() {
            const storedStudents = localStorage.getItem('classStudents');
            if (storedStudents) {
                students = JSON.parse(storedStudents);
            }
        }
        function saveStudents() {
            localStorage.setItem('classStudents', JSON.stringify(students));
        }

        // --- 核心邏輯函式 ---

        function updateUI() {
            // 1. 更新下拉選單
            const select = document.getElementById('studentSelect');
            // 保存當前選中的值，以便在重新渲染後嘗試恢復選取狀態
            const currentSelectedValue = select.value;
            
            select.innerHTML = '';
            if (students.length === 0) {
                const option = document.createElement('option');
                option.text = '請先新增學生';
                option.disabled = true;
                select.add(option);
            } else {
                students.forEach((s, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.text = s.name; // 這裡使用 text，是安全的
                    select.add(option);
                });
                // 如果之前選中的索引仍然有效，則恢復選取
                if (currentSelectedValue !== '' && currentSelectedValue < students.length) {
                    select.value = currentSelectedValue;
                }
            }

            // 2. 更新表格 (*** 安全修正 ***)
            const table = document.getElementById('studentTable');
            table.innerHTML = '';
            if (students.length === 0) {
                const row = table.insertRow();
                row.innerHTML = `<td colspan="7" class="px-6 py-8 text-center text-gray-500">目前沒有學生資料，請從上方新增。</td>`;
            } else {
                students.forEach((s, i) => {
                    const leave = s.leave.map(l => `${l.date}(${l.type})`).join(', ');
                    const miss = s.miss.map(d => d).join(', ');

                    const row = table.insertRow();
                    row.className = 'hover:bg-gray-50 transition-colors';

                    // Cell 0: Checkbox
                    const cellCheckbox = row.insertCell();
                    cellCheckbox.className = 'px-4 py-4 text-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'student-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                    checkbox.dataset.index = i;
                    checkbox.onchange = updateBatchDeleteBtnState;
                    cellCheckbox.appendChild(checkbox);

                    // Cell 1: Name (使用 textContent 確保安全)
                    const cellName = row.insertCell();
                    cellName.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                    cellName.textContent = s.name; // 安全的寫法

                    // Cell 2: Points
                    const cellPoints = row.insertCell();
                    cellPoints.className = `px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center font-semibold ${s.points < 0 ? 'text-red-600' : ''}`;
                    cellPoints.textContent = s.points;

                    // Cell 3: Warning
                    const cellWarning = row.insertCell();
                    cellWarning.className = `px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center ${s.warning > 0 ? 'text-red-600 font-bold' : ''}`;
                    cellWarning.textContent = s.warning;

                    // Cell 4: Leave (使用 textContent 確保安全)
                    const cellLeave = row.insertCell();
                    cellLeave.className = 'px-6 py-4 text-sm text-gray-500 min-w-[150px]';
                    cellLeave.textContent = leave || '-'; // 安全的寫法

                    // Cell 5: Miss (使用 textContent 確保安全)
                    const cellMiss = row.insertCell();
                    cellMiss.className = 'px-6 py-4 text-sm text-gray-500 min-w-[150px]';
                    cellMiss.textContent = miss || '-'; // 安全的寫法

                    // Cell 6: Actions (Button)
                    const cellAction = row.insertCell();
                    cellAction.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 px-3 py-1 rounded-md transition-colors';
                    deleteBtn.textContent = '刪除';
                    // 使用箭頭函式來正確傳遞索引 i
                    deleteBtn.onclick = () => confirmDeleteSingle(i); 
                    cellAction.appendChild(deleteBtn);
                });
            }

            // 3. 重置全選按鈕狀態 & 批次刪除按鈕狀態
            document.getElementById('selectAll').checked = false;
            updateBatchDeleteBtnState();
        }

        // (已移除 escapeHtml 函式，因為不再需要)

        // --- 新增/刪除功能 ---

        function addStudent() {
            const nameInput = document.getElementById('newStudent');
            const name = nameInput.value.trim();
            if (!name) {
                showToast('請輸入學生姓名', true);
                return;
            }
            // 這裡不需要檢查 XSS，因為我們在渲染時已經處理了
            if (students.some(s => s.name === name)) {
                showToast(`學生 "${name}" 已經存在`, true);
                return;
            }
            students.push({ name: name, points: 0, warning: 0, leave: [], miss: [] });
            nameInput.value = '';
            showToast(`已新增學生 ${name}`);
            saveAndUpate();
        }

        // 單一刪除確認
        function confirmDeleteSingle(index) {
            // 檢查索引是否有效 (避免在快速點擊或資料不同步時出錯)
            if (!students[index]) return; 
            
            const student = students[index];
            showConfirm(`確定要刪除學生「${student.name}」嗎？此操作無法復原。`, () => {
                students.splice(index, 1);
                showToast(`已刪除 ${student.name}`);
                saveAndUpate();
            }, true); // true 表示為危險操作，Modal 按鈕會變紅
        }

        // --- 批次操作相關 ---

        // 全選/取消全選
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');
            studentCheckboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
            updateBatchDeleteBtnState();
        }

        // 更新「批次刪除」按鈕的啟用狀態
        function updateBatchDeleteBtnState() {
            const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            batchDeleteBtn.disabled = checkedCount === 0;
            if (checkedCount > 0) {
                batchDeleteBtn.textContent = `批次刪除 (${checkedCount})`;
            } else {
                batchDeleteBtn.textContent = `批次刪除`;
            }
        }

        // 批次刪除確認
        function confirmBatchDelete() {
            const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
            if (checkedBoxes.length === 0) return;

            const count = checkedBoxes.length;
            showConfirm(`確定要刪除選取的 ${count} 位學生嗎？此操作無法復原。`, () => {
                // 取得所有要刪除的索引 (轉成數字)
                const indexesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index));
                
                // 使用 filter 保留「不在」刪除清單中的學生
                // 這樣比用 splice 從後往前刪更乾淨易讀
                students = students.filter((_, index) => !indexesToDelete.includes(index));
                
                showToast(`已批次刪除 ${count} 位學生`);
                saveAndUpate();
            }, true);
        }

        // --- 原有的操作功能 ---
        function modifyPoint(num) {
            const idx = document.getElementById('studentSelect').value;
            if (idx === '' || students.length === 0 || !students[idx]) return showToast('請先選取一位學生', true);
            students[idx].points += num;
            showToast(`${students[idx].name} ${num > 0 ? '加點' : '扣點'}成功`);
            saveAndUpate();
        }

        function modifyWarning(num) {
            const idx = document.getElementById('studentSelect').value;
            if (idx === '' || students.length === 0 || !students[idx]) return showToast('請先選取一位學生', true);
            students[idx].warning = Math.max(0, students[idx].warning + num);
            showToast(`${students[idx].name} ${num > 0 ? '新增警告' : '刪除警告'}成功`);
            saveAndUpate();
        }

        function redeem(item) {
            const idx = document.getElementById('studentSelect').value;
            if (idx === '' || students.length === 0 || !students[idx]) return showToast('請先選取一位學生', true);
            let cost = (item === 'ice') ? 50 : 150;
            let itemName = (item === 'ice') ? '冰棒' : '飲料';
            if (students[idx].points >= cost) {
                showConfirm(`確定要幫 ${students[idx].name} 兌換${itemName}嗎？將扣 ${cost} 點`, () => {
                    students[idx].points -= cost;
                    showToast(`${students[idx].name} 已兌換${itemName}！`);
                    saveAndUpate();
                });
            } else {
                showToast('點數不足，無法兌換', true);
            }
        }

        function addLeave() {
            const idx = document.getElementById('studentSelect').value;
            if (idx === '' || students.length === 0 || !students[idx]) return showToast('請先選取一位學生', true);
            const type = document.getElementById('leaveType').value;
            const date = new Date().toLocaleDateString();
            students[idx].leave.push({ date: date, type: type });
            showToast(`${students[idx].name} 已新增請假紀錄`);
            saveAndUpate();
        }

        function missRunning() {
            const idx = document.getElementById('studentSelect').value;
            if (idx === '' || students.length === 0 || !students[idx]) return showToast('請先選取一位學生', true);
            const date = new Date().toLocaleDateString();
            students[idx].miss.push(date);
            showToast(`${students[idx].name} 記錄沒跑步`);
            saveAndUpate();
        }

        function saveAndUpate() {
            saveStudents();
            updateUI();
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadStudents();
            updateUI();
        });

    </script>

</body>
</html>